#!/usr/bin/env bash

set -e

cd "$(dirname "$0")/.."

# Create config dir if not present
if [[ ! -d "${PWD}/config" ]]; then
    mkdir -p "${PWD}/config"
    uv run hass --config "${PWD}/config" --script ensure_config
fi

# Set the path to custom_components
## This let's us have the structure we want <root>/custom_components/integration_blueprint
## while at the same time have Home Assistant configuration inside <root>/config
## without resulting to symlinks.
export PYTHONPATH="${PYTHONPATH}:${PWD}/custom_components"

# Start Home Assistant with filtered log output
# Filter removes timestamp and thread name, keeps log level, extracts last module name
# Color codes log levels: ERROR/CRITICAL=red, WARNING=yellow, INFO=green, DEBUG=dim
uv run hass --config "${PWD}/config" --debug 2>&1 | stdbuf -oL -eL sed -E \
  -e 's/^[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}\.[0-9]{3} //' \
  -e 's/^([A-Z]+) \([^)]+\) \[([^\]]+)\]/\1 [\2]/' \
  -e 's/\[([^.]*\.)*([^.]*)\]/\2/' \
  -e 's/^([A-Z]+) \[([^\]]+)\]/\1 [\2]/' | \
stdbuf -oL python3 -u -c "
import sys
RED = '\033[0;31m'
YELLOW = '\033[1;33m'
GREEN = '\033[0;32m'
DIM = '\033[2m'
RESET = '\033[0m'

try:
    while True:
        line = sys.stdin.readline()
        if not line:
            break
        line = line.rstrip('\n\r')
        if line.startswith('ERROR ') or line.startswith('CRITICAL '):
            sys.stdout.write(f'{RED}{line}{RESET}\n')
        elif line.startswith('WARNING '):
            sys.stdout.write(f'{YELLOW}{line}{RESET}\n')
        elif line.startswith('INFO '):
            sys.stdout.write(f'{GREEN}{line}{RESET}\n')
        elif line.startswith('DEBUG '):
            sys.stdout.write(f'{DIM}{line}{RESET}\n')
        else:
            sys.stdout.write(f'{line}\n')
        sys.stdout.flush()
except KeyboardInterrupt:
    sys.exit(0)
"